//
//  ContentView.swift
//  Peaceful Wake Up
//
//  Created by Mike McDonald on 9/7/25.
//  Refactored on 9/26/25 for better modularity
//

import SwiftUI
import SwiftData
import AVFoundation


struct ContentView: View {
    // MARK: - Dependency Injection
    private let dependencyContainer: DependencyContainer
    
    // MARK: - Managers
    // Use explicit type to resolve ambiguity between Managers/AlarmManager and Models/AlarmManager
    @StateObject private var alarmManager: AlarmManager = AlarmManager()
    @StateObject private var audioManager = AudioManager()
    @StateObject private var backgroundTaskManager = BackgroundTaskManager()
    @StateObject private var notificationManager = NotificationManager()
    
    // MARK: - Initialization
    init() {
        self.dependencyContainer = .shared
    }
    
    // MARK: - Additional Managers
    @StateObject private var appStateManager = AppStateManager.shared
    @StateObject private var performanceMetrics = PerformanceMetrics()
    
    // Use existing BrightnessManager as @Observable
    @State private var brightnessManager = BrightnessManager()
    
    // MARK: - UI State (minimal state in main view)
    @State private var lastInteraction: Date = Date()
    @State private var currentTime: Date = Date()
    private let timer = Timer.publish(every: 1.0, on: .main, in: .common).autoconnect()

    var body: some View {
        TimelineView(PeriodicTimelineSchedule(from: Date(), by: 1.0)) { context in
            mainView(currentTime: context.date)
        }
        .onAppear {
            setupApp()
        }
        .overlay(PerformanceTestingOverlay())
        .testingIdentifier(.mainContainer)
        .onDisappear {
            cleanupApp()
        }
        .onReceive(NotificationCenter.default.publisher(for: UIApplication.willResignActiveNotification)) { _ in
            backgroundTaskManager.handleAppGoingToBackground()
        }
        .onReceive(NotificationCenter.default.publisher(for: UIApplication.didBecomeActiveNotification)) { _ in
            backgroundTaskManager.handleAppReturningToForeground()
        }
        .onReceive(timer) { _ in
            currentTime = Date()
        }
    }
    
    @ViewBuilder
    private func mainView(currentTime: Date) -> some View {
        ZStack {
                // Sunrise gradient background - fills entire screen
                SunriseBackgroundView()
                
                // Main content
                VStack(spacing: 0) {
                    // Title at the very top with iOS version info in debug
                    VStack {
                        Text("Peaceful Wake Up")
                            .font(.largeTitle)
                            .foregroundColor(.white.opacity(1.0))
                        
                        #if DEBUG
                        Text("iOS \(iOSCompatibility.versionString)")
                            .font(.caption)
                            .foregroundColor(.white.opacity(0.6))
                        #endif
                    }
                    .padding(.top, 50)
                    .padding(.bottom, 20)
                    .onTapGesture {
                        handleTapToDismissAlarmSetter()
                    }
                    
                    Spacer()
                        .onTapGesture {
                            handleTapToDismissAlarmSetter()
                        }
                    
                    // Current time and alarm display - now uses TimelineView's currentTime
                    TimeDisplayView(
                        currentTime: currentTime,
                        alarmTime: alarmManager.alarmTime,
                        isAlarmSet: alarmManager.isAlarmSet,
                        timeUntilAlarm: alarmManager.timeUntilAlarm(currentTime: currentTime),
                        onTapGesture: handleTapToDismissAlarmSetter
                    )
                    
                    Spacer()
                        .onTapGesture {
                            handleTapToDismissAlarmSetter()
                        }
                    
                    // Main alarm interface at bottom
                    VStack {
                        // Only show DatePicker when setting alarm
                        if alarmManager.showingAlarmSetter {
                            AlarmSetterView(
                                alarmTime: $alarmManager.alarmTime,
                                isSilentAlarm: $alarmManager.isSilentAlarm,
                                showingAlarmSetter: $alarmManager.showingAlarmSetter,
                                onConfirm: alarmManager.setAlarm
                            )
                            .transition(.scale.combined(with: .opacity))
                        }
                        
                        // Show different UI based on alarm state
                        AlarmControlsView(
                            isAlarmSet: alarmManager.isAlarmSet,
                            showingAlarmSetter: alarmManager.showingAlarmSetter,
                            buttonText: alarmManager.buttonText,
                            buttonColor: alarmManager.buttonColor,
                            onAlarmButton: handleAlarmButton,
                            onCancel: handleCancelAlarm
                        )
                    }
                    .padding(.horizontal)
                    .padding(.bottom, 30)
                }
                
                // Brightness overlays - use existing BrightnessManager structure
                BrightnessOverlayView(
                    currentBrightness: brightnessManager.currentBrightness,
                    showBlackOverlay: brightnessManager.showBlackOverlay,
                    currentTime: currentTime,
                    onTap: userInteracted,
                    setBrightness: { brightness in
                        brightnessManager.setBrightnessSafely(brightness)
                    }
                )
                
                if alarmManager.isAlarmSet {
                    SunriseTimelineView(
                        alarmTime: alarmManager.alarmTime,
                        hasEnteredSunrisePhase: $alarmManager.hasEnteredSunrisePhase,
                        brightnessManager: brightnessManager,
                        onAlarmCompleted: handleAlarmCompleted
                    )
                }
                
                if let alarmStartTime = alarmManager.alarmStartTime {
                    VolumeTimelineView(
                        alarmStartTime: alarmStartTime,
                        setSystemVolume: audioManager.setSystemVolume
                    )
                }
                
                // Add missing InactivityTimelineView for proper user interaction monitoring
                InactivityTimelineView(
                    lastInteraction: lastInteraction,
                    isAlarmSet: alarmManager.isAlarmSet,
                    alarmTime: alarmManager.alarmTime,
                    showBlackOverlay: $brightnessManager.showBlackOverlay,
                    currentBrightness: $brightnessManager.currentBrightness,
                    brightnessBeforeInactivity: $brightnessManager.brightnessBeforeInactivity
                )
            }
        }
        .contentShape(Rectangle())
        .simultaneousGesture(
            TapGesture()
                .onEnded { _ in
                    userInteracted()
                }
        )
    }
    
    // MARK: - Helper Functions
    private func handleTapToDismissAlarmSetter() {
        if alarmManager.showingAlarmSetter {
            withAnimation(AnimationCompat.easeInOut) {
                alarmManager.showingAlarmSetter = false
            }
        }
    }
    
    private func handleAlarmButton() {
        if alarmManager.isAlarmSet {
            handleCancelAlarm()
        } else if alarmManager.showingAlarmSetter {
            alarmManager.setAlarm()
        } else {
            withAnimation(.easeInOut(duration: 0.3)) {
                alarmManager.showingAlarmSetter = true
            }
        }
    }
    
    private func handleCancelAlarm() {
        alarmManager.cancelAlarm()
        audioManager.stopAlarmSound()
        UIApplication.shared.isIdleTimerDisabled = false
    }
    
    private func handleAlarmCompleted() {
        audioManager.playAlarmSound()
    }
    
    private func userInteracted() {
        lastInteraction = Date()
        brightnessManager.userInteracted()
    }
    
    // MARK: - App Lifecycle
    private func setupApp() {
        AppLogger.info("App setup started", category: .system)
        let measurement = PerformanceMeasurement(operation: "App Setup", category: .system)
        
        // Setup managers
        brightnessManager.setupBrightness()
        UIApplication.shared.isIdleTimerDisabled = true
        audioManager.setupAudioSession()
        audioManager.preloadAudioResources()
        
        // Setup notifications
        notificationManager.setupNotificationObservers(
            onMemoryWarning: handleMemoryWarning,
            onAudioInterruption: audioManager.handleAudioSessionInterruption
        )
        
        let setupTime = measurement.end()
        performanceMetrics.recordAudioSetupTime(setupTime)
        AppLogger.info("App setup completed", category: .system)
    }
    
    private func cleanupApp() {
        AppLogger.info("App cleanup started", category: .system)
        
        performanceMetrics.logMetrics()
        notificationManager.removeNotificationObservers()
        UIApplication.shared.isIdleTimerDisabled = false
        audioManager.stopAlarmSound()
        audioManager.cleanupAudioResources()
        backgroundTaskManager.endBackgroundTask()
        
        AppLogger.info("App cleanup completed", category: .system)
    }
    
    private func handleMemoryWarning() {
        print("Received memory warning - performing cleanup")
        if !alarmManager.isAlarmSet {
            audioManager.cleanupAudioResources()
        }
        performanceMetrics.logMetrics()
    }
}
